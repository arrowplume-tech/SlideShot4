# Анализ проблемы с Puppeteer в PastedSlideShot

Судя по логу, проблема в том, что Puppeteer браузер не запускается и система fallback'ится на традиционный парсер. Это приводит к некорректной обработке элементов. Давайте разберем возможные причины и решения.

## Возможные причины проблемы

### 1. Отсутствие Puppeteer в зависимостях
```bash
# Проверьте установлен ли Puppeteer
npm list puppeteer
# или
yarn list puppeteer
```

### 2. Проблемы с окружением
- Puppeteer требует наличия Chromium/Chrome в системе
- На некоторых серверах (особенно в Docker) может не быть необходимых библиотек
- Проблемы с правами доступа

### 3. Неправильная конфигурация
Возможно, в коде есть проблема с инициализацией Puppeteer.

## Решения

### 1. Установка и настройка Puppeteer

```bash
# Установка Puppeteer
npm install puppeteer
# или для легковесной версии
npm install puppeteer-core
```

### 2. Исправление кода для запуска Puppeteer

Вот исправленный код для обработки Puppeteer:

```typescript
// src/lib/browser-parser.ts
import puppeteer from 'puppeteer';
import { Browser } from 'puppeteer';

export class BrowserParser {
  private browser: Browser | null = null;
  private isAvailable: boolean = false;

  async initialize(): Promise<boolean> {
    try {
      console.log('Инициализация headless браузера...');
      
      // Попытка запуска с различными опциями
      const launchOptions = {
        headless: true,
        args: [
          '--no-sandbox',
          '--disable-setuid-sandbox',
          '--disable-dev-shm-usage',
          '--disable-accelerated-2d-canvas',
          '--no-first-run',
          '--no-zygote',
          '--single-process',
          '--disable-gpu'
        ]
      };

      // Для Docker окружения
      if (process.env.NODE_ENV === 'production') {
        launchOptions.args.push('--disable-extensions');
      }

      this.browser = await puppeteer.launch(launchOptions);
      this.isAvailable = true;
      console.log('Headless браузер успешно запущен');
      return true;
    } catch (error) {
      console.error('Ошибка запуска headless браузера:', error);
      this.isAvailable = false;
      return false;
    }
  }

  async parseHTML(html: string, css: string): Promise<any> {
    if (!this.isAvailable || !this.browser) {
      throw new Error('Браузер недоступен');
    }

    const page = await this.browser.newPage();
    
    try {
      // Установка контента страницы
      await page.setContent(`
        <!DOCTYPE html>
        <html>
          <head>
            <style>
              ${css}
            </style>
          </head>
          <body>
            ${html}
          </body>
        </html>
      `, { waitUntil: 'networkidle0' });

      // Ожидание рендеринга
      await page.waitForTimeout(1000);

      // Получение вычисленных стилей
      const elements = await page.evaluate(() => {
        const allElements = document.body.querySelectorAll('*');
        const results = [];

        allElements.forEach((el, index) => {
          const styles = window.getComputedStyle(el);
          const rect = el.getBoundingClientRect();

          // Пропуск невидимых элементов
          if (styles.display === 'none' || 
              styles.visibility === 'hidden' || 
              styles.opacity === '0' ||
              rect.width === 0 || 
              rect.height === 0) {
            return;
          }

          results.push({
            index,
            tagName: el.tagName.toLowerCase(),
            text: el.textContent?.trim(),
            rect: {
              x: rect.left,
              y: rect.top,
              width: rect.width,
              height: rect.height
            },
            styles: Object.fromEntries(
              Array.from(styles).map(key => [key, styles.getPropertyValue(key)])
            )
          });
        });

        return results;
      });

      return elements;
    } finally {
      await page.close();
    }
  }

  async close(): Promise<void> {
    if (this.browser) {
      await this.browser.close();
      this.browser = null;
      this.isAvailable = false;
    }
  }
}
```

### 3. Интеграция с основным кодом

```typescript
// src/app/api/convert/route.ts
import { BrowserParser } from '@/lib/browser-parser';
import { HTMLParser } from '@/lib/html-parser';

export async function POST(req: NextRequest) {
  try {
    const { html, css } = await req.json();
    
    console.log('Starting HTML to PowerPoint conversion...');
    
    let elements = [];
    let parser: BrowserParser | HTMLParser;
    
    // Попытка использовать браузерный парсер
    const browserParser = new BrowserParser();
    const browserAvailable = await browserParser.initialize();
    
    if (browserAvailable) {
      console.log('Используем headless браузер для точного расчета...');
      try {
        elements = await browserParser.parseHTML(html, css);
        console.log(`Парсинг через браузер выполнен: ${elements.length} элементов`);
      } catch (error) {
        console.error('Ошибка браузерного парсинга:', error);
        // Fallback к традиционному парсеру
        parser = new HTMLParser();
        elements = parser.parse(html, css);
        console.log('Fallback к традиционному парсингу');
      } finally {
        await browserParser.close();
      }
    } else {
      console.log('Браузер недоступен, используется традиционный парсер HTML');
      parser = new HTMLParser();
      elements = parser.parse(html, css);
      console.log(`Парсинг выполнен традиционным методом: ${elements.length} элементов`);
    }
    
    // Продолжение обработки...
  } catch (error) {
    console.error('Ошибка конвертации:', error);
    return NextResponse.json(
      { error: 'Failed to convert', details: error.message },
      { status: 500 }
    );
  }
}
```

### 4. Docker-совместимая версия

Если вы используете Docker, добавьте это в Dockerfile:

```dockerfile
# Установка зависимостей для Puppeteer
RUN apt-get update && apt-get install -y \
    wget \
    gnupg \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Установка Chromium
RUN wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add - \
    && sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google.list' \
    && apt-get update \
    && apt-get install -y google-chrome-stable \
    && rm -rf /var/lib/apt/lists/*

# Установка Puppeteer с пропуском скачивания Chromium
ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true \
    PUPPETEER_EXECUTABLE_PATH=/usr/bin/google-chrome-stable
```

### 5. Альтернативный подход - Playwright

Если Puppeteer продолжает вызывать проблемы, можно использовать Playwright:

```typescript
import { chromium } from 'playwright';

export class PlaywrightParser {
  async parseHTML(html: string, css: string): Promise<any> {
    const browser = await chromium.launch();
    const page = await browser.newPage();
    
    try {
      await page.setContent(`
        <!DOCTYPE html>
        <html>
          <head>
            <style>${css}</style>
          </head>
          <body>${html}</body>
        </html>
      `);

      const elements = await page.evaluate(() => {
        // Та же логика, что и для Puppeteer
      });

      return elements;
    } finally {
      await browser.close();
    }
  }
}
```

### 6. Проверка доступности браузера

Добавьте функцию для проверки доступности браузера:

```typescript
async function checkBrowserAvailability(): Promise<boolean> {
  try {
    const browser = await puppeteer.launch({
      headless: true,
      args: ['--no-sandbox', '--disable-setuid-sandbox']
    });
    await browser.close();
    return true;
  } catch (error) {
    console.error('Браузер недоступен:', error);
    return false;
  }
}

// Использование в API
const browserAvailable = await checkBrowserAvailability();
```

## Рекомендации

1. **Для разработки**: Установите Puppeteer локально и проверьте работу
2. **Для продакшена**: Используйте Docker-образ с предустановленным Chromium
3. **Мониторинг**: Добавьте логирование для отслеживания работы браузера
4. **Fallback**: Всегда имейте запасной вариант (традиционный парсер)

## Отладка

Добавьте детальное логирование для диагностики:

```typescript
console.log('Проверка доступности Puppeteer...');
console.log('Node.js версия:', process.version);
console.log('Окружение:', process.env.NODE_ENV);
console.log('Платформа:', process.platform);
```

Эти изменения должны решить проблему с запуском Puppeteer и обеспечить корректную работу парсера HTML.